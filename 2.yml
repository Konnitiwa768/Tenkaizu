<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>マイクラ防具表示</title>
  <style>
    body { margin: 0; overflow: hidden; background: #111; }
    #controls {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 10;
      background: rgba(255,255,255,0.8);
      padding: 10px;
      border-radius: 6px;
    }
  </style>
</head>
<body>
  <div id="controls">
    <label>layer_1: <input type="file" id="layer1" accept="image/*"></label><br>
    <label>layer_2: <input type="file" id="layer2" accept="image/*"></label>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/three@0.148.0/build/three.min.js"></script>
  <script>
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 0.1, 1000);
    camera.position.z = 5;

    const renderer = new THREE.WebGLRenderer({antialias: true});
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    const light = new THREE.DirectionalLight(0xffffff, 1);
    light.position.set(3, 5, 2).normalize();
    scene.add(light);

    let textures = [null, null];

    function loadTextureFromFile(index, file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const img = new Image();
          img.onload = () => {
            const tex = new THREE.Texture(img);
            tex.needsUpdate = true;
            tex.magFilter = THREE.NearestFilter;
            tex.minFilter = THREE.NearestFilter;
            textures[index] = tex;
            resolve();
          };
          img.src = e.target.result;
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    async function tryBuildArmor() {
      if (!textures[0] || !textures[1]) return;

      while (scene.children.length > 0) scene.remove(scene.children[0]);
      scene.add(light);

      // 頭（ヘルメット） - layer2
      scene.add(createBox(1, 1, 1, 0, 2.5, 0, textures[1]));

      // 胴体 - layer1
      scene.add(createBox(1.5, 1.5, 0.5, 0, 1, 0, textures[0]));

      // 足 - layer1
      scene.add(createBox(1.2, 1.2, 0.5, 0, -0.5, 0, textures[0]));

      // ブーツ - layer1（左右）
      scene.add(createBox(0.5, 0.5, 0.5, -0.4, -1.5, 0, textures[0]));
      scene.add(createBox(0.5, 0.5, 0.5,  0.4, -1.5, 0, textures[0]));
    }

    function createBox(w, h, d, x, y, z, texture) {
      const geometry = new THREE.BoxGeometry(w, h, d);
      const material = new THREE.MeshBasicMaterial({ map: texture });
      const mesh = new THREE.Mesh(geometry, material);
      mesh.position.set(x, y, z);
      return mesh;
    }

    document.getElementById("layer1").addEventListener("change", async (e) => {
      if (e.target.files.length === 0) return;
      await loadTextureFromFile(0, e.target.files[0]);
      tryBuildArmor();
    });

    document.getElementById("layer2").addEventListener("change", async (e) => {
      if (e.target.files.length === 0) return;
      await loadTextureFromFile(1, e.target.files[0]);
      tryBuildArmor();
    });

    function animate() {
      requestAnimationFrame(animate);
      scene.rotation.y += 0.01;
      renderer.render(scene, camera);
    }

    animate();
  </script>
</body>
</html>
